function manipulateParameters
clear all
initUi()
%% Initialise sliders and graph
    function initUi()
        hfig = figure('units','normalized','outerposition',[0 0 .35 .75]);
        
        initSliderParams(hfig);
        initPlot(hfig);
        
        %% Sliders
        sHeight = 0.03;
        sWidth = 0.1;
        sLeft = 0.015;
        sY = 0.01;
        
        sTextLeft = 0;
        sTextHeight = 0.025;
        sTextWidth = 0.015;
        
        slider1 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY sWidth sHeight],...
            'Tag','slider1',...
            'Value',getappdata(hfig,'alpha'),...
            'Callback',@slider_callback1);
        slider1_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY sTextWidth sTextHeight],...
            'String','α');
        
        slider2 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY+sHeight sWidth sHeight],...
            'Tag','slider2',...
            'Min',0,'Max',2,...
            'Value',getappdata(hfig,'beta'),...
            'Callback',@slider_callback2);
        slider2_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY+sHeight sTextWidth sTextHeight],...
            'String','β');
        
        slider3 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY+2*sHeight sWidth sHeight],...
            'Tag','slider3',...
            'Value',getappdata(hfig,'gamma'),...
            'Callback',@slider_callback3);
        slider3_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY+2*sHeight sTextWidth sTextHeight],...
            'String','γ');
        
        slider4 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY+3*sHeight sWidth sHeight],...
            'Tag','slider4',...
            'Value',getappdata(hfig,'u'),...
            'Callback',@slider_callback4);
        slider4_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY+3*sHeight sTextWidth sTextHeight],...
            'String','u');
        
        slider5 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY+4*sHeight sWidth sHeight],...
            'Tag','slider4',...
            'Value',getappdata(hfig,'delta'),...
            'Callback',@slider_callback5);
        slider5_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY+4*sHeight sTextWidth sTextHeight],...
            'String','δ');
        
        slider6 = uicontrol('Parent', hfig,'Style','slider',...
            'Units','normalized',...
            'Position',[sLeft sY+5*sHeight sWidth sHeight],...
            'Tag','slider4',...
            'Value',getappdata(hfig,'bOffset'),...
            'Callback',@slider_callback6);
        slider6_label = uicontrol('Parent',hfig,'Style','text',...
            'Units','normalized',...
            'Position',[sTextLeft sY+5*sHeight sTextWidth sTextHeight],...
            'String','βc');
        
%         slider7 = uicontrol('Parent', hfig,'Style','slider',...
%             'Units','normalized',...
%             'Position',[sLeft sY+6*sHeight sWidth sHeight],...
%             'Tag','slider7',...
%                         'Min',0.001, 'Max',0.5,...
%             'Value',getappdata(hfig,'tf'),...
%             'Callback',@slider_callback7);
%         slider7_label = uicontrol('Parent',hfig,'Style','text',...
%             'Units','normalized',...
%             'Position',[sTextLeft sY+6*sHeight sTextWidth sTextHeight],...
%             'String','τf');
        
%         slider8 = uicontrol('Parent', hfig,'Style','slider',...
%             'Units','normalized',...
%             'Position',[sLeft sY+7*sHeight sWidth sHeight],...
%             'Tag','slider8',...
%                         'Min',100,'Max',1000,...
%             'Value',getappdata(hfig,'tus'),...
%             'Callback',@slider_callback8);
%         slider8_label = uicontrol('Parent',hfig,'Style','text',...
%             'Units','normalized',...
%             'Position',[sTextLeft sY+7*sHeight sTextWidth sTextHeight],...
%             'String','τu');
        
%         slider9 = uicontrol('Parent', hfig,'Style','slider',...
%             'Units','normalized',...
%             'Position',[sLeft sY+8*sHeight sWidth sHeight],...
%             'Tag','slider9',...
%                         'Min',-2,'Max',2,...
%             'Value',getappdata(hfig,'alpha_const'),...
%                         'Callback',@slider_callback9);
%         slider9_label = uicontrol('Parent',hfig,'Style','text',...
%             'Units','normalized',...
%             'Position',[sTextLeft sY+8*sHeight sTextWidth sTextHeight],...
%             'String','αc');
        
%         slider10 = uicontrol('Parent', hfig,'Style','slider',...
%             'Units','normalized',...
%             'Position',[sLeft sY+9*sHeight sWidth sHeight],...
%             'Tag','slider10',...
%                         'Min',1000,'Max',10000,...
%             'Value',getappdata(hfig,'tmax'),...
%             'Callback',@slider_callback10);
%         slider10_label = uicontrol('Parent',hfig,'Style','text',...
%             'Units','normalized',...
%             'Position',[sTextLeft sY+9*sHeight sTextWidth sTextHeight],...
%             'String','T');
                
%         busy_label = uicontrol('Parent',hfig,'Style','text',...
%             'Units','normalized',...
%             'Position',[sTextLeft sY+10*sHeight sTextWidth*7 sTextHeight],...
%             'String','Busy');
        
    end

%% Callback functions
    function slider_callback1(hObject,eventdata)
        setappdata(hObject.Parent,'alpha',hObject.Value);
        updatePlot(hObject)
    end

    function slider_callback2(hObject,eventdata)
        setappdata(hObject.Parent,'beta',hObject.Value);
        updatePlot(hObject)

    end

    function slider_callback3(hObject,eventdata)
        setappdata(hObject.Parent,'gamma',hObject.Value);
        updatePlot(hObject)
    end
    function slider_callback4(hObject,eventdata)
        setappdata(hObject.Parent,'u',hObject.Value);
        updatePlot(hObject)
    end

    function slider_callback5(hObject,eventdata)
        setappdata(hObject.Parent,'delta',hObject.Value);
        updatePlot(hObject)
    end

    function slider_callback6(hObject,eventdata)
        setappdata(hObject.Parent,'bOffset',hObject.Value);
        updatePlot(hObject)
    end


    function slider_callback7(hObject,eventdata)
        setappdata(hObject.Parent,'tf',hObject.Value);
        updatePlot(hObject)
    end
    function slider_callback8(hObject,eventdata)
        setappdata(hObject.Parent,'tus',hObject.Value);
        updatePlot(hObject)
    end
    function slider_callback9(hObject,eventdata)
        setappdata(hObject.Parent,'alpha_const',hObject.Value);
        updatePlot(hObject)
    end
    function slider_callback10(hObject,eventdata)
        setappdata(hObject.Parent,'tmax',hObject.Value);
        updatePlot(hObject)
    end

%% Update plot
    function updatePlot(hObject)
        % Nullclines
        bump = @(x,delta) (tanh(x+delta) - tanh(x-delta) -2*tanh(delta));
        fast_nullcline = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + tanh(xf+ bump(u + xs +0.5*gamma*xf,delta) + beta*xf+ alpha))/ef);
        fast_nullcline_relay = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + sign(bump(u + xs +0.5*gamma*xf,delta) + beta*xf+ alpha))/ef);
        fast_nullcline_piecewise = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + tanh(xf+ piece_wise_bump_2(u + xs +0.5*gamma*xf) + beta*xf+ alpha))/ef);
        fast_nullcline_relay_piecewise = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + sign(piece_wise_bump_2(u + xs +0.5*gamma*xf) + beta*xf+ alpha))/ef);
        linear_plant = @(xs,xf,ts) (xf-xs*ts);
        
        % Get slider values 
        alpha = getappdata(hObject.Parent,'alpha');
        beta = getappdata(hObject.Parent,'beta')
        beta_relay = beta -1;
        gamma = getappdata(hObject.Parent,'gamma');
        u = getappdata(hObject.Parent,'u');
        delta = getappdata(hObject.Parent,'delta');
        ts = getappdata(hObject.Parent,'ts');
        %         fprintf('α    β    γ    δ    u    τ_s \n')
        %         disp([alpha beta gamma delta u ts])
        
        % Other parameters
        tf = 0.0075;
        
        h1 = ezplot(@(x,y)fast_nullcline_piecewise(x,y,u,gamma,beta,alpha,delta,tf),[-4,4]);
        hold on
        h2 = ezplot(@(x,y)fast_nullcline_relay_piecewise(x,y,u,gamma,beta_relay,alpha,delta,tf),[-4,4]);
        set(h1,'Color','b');
        set(h2,'Color','r');

%         h2 = ezplot(@(x,y)linear_plant(x,y,ts),[-4,4]);
        %         text = sprintf('\\alpha = %f',alpha);
        %         legend(text)
        %         display( getappdata(hObject.Parent,'Sl_alpha'));
        % % 	diffval = getappdata(hObject.Parent,'difference');
        % % 	display([currentval
        
        title('Nullclines');
        xlabel('xs');
        ylabel('xf');
        legend('tanh','relay')
        hold off
        
    end

    function initPlot(hfig)
        % Nullclines
        bump = @(x,delta) (tanh(x+delta) - tanh(x-delta) -2*tanh(delta));
        fast_nullcline = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + tanh(xf+ bump(u + xs +0.5*gamma*xf,delta) + beta*xf+ alpha))/ef);
        fast_nullcline_relay = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + sign(bump(u + xs +0.5*gamma*xf,delta) + beta*xf+ alpha))/ef);
        fast_nullcline_piecewise = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + tanh(xf+ piece_wise_bump_2(u + xs +0.5*gamma*xf) + beta*xf+ alpha))/ef);
        
        fast_nullcline_relay_piecewise = @(xs,xf,u,gamma,beta,alpha,delta,ef)...
            ((-xf + sign(piece_wise_bump_2(u + xs +0.5*gamma*xf) + beta*xf+ alpha))/ef);
        linear_plant = @(xs,xf,ts) (xf-xs*ts);
        
        % parameters
        alpha = 0.5;
        beta = 0.5;
        beta_relay = beta -1;
        gamma = 1;
        delta = 0.5;
        u = 0.5;
        tf = 0.5;
        ts = 1;
        tf = 0.0075;
        
        h1 = ezplot(@(x,y)fast_nullcline_piecewise(x,y,u,gamma,beta,alpha,delta,tf),[-4,4]);
        hold on
        h2 = ezplot(@(x,y)fast_nullcline_relay_piecewise(x,y,u,gamma,beta_relay,alpha,delta,tf),[-4,4]);
        set(h1,'Color','b');
        set(h2,'Color','r');
        hold on
        title('Nullclines');
        xlabel('xs');
        ylabel('xf');
        hold off
        
    end

    function initSliderParams(hfig)
        % Set parameter values
        setappdata(hfig,'alpha',0.5);
        setappdata(hfig,'beta',0.27);
        setappdata(hfig,'gamma',1);
        setappdata(hfig,'delta',0.5);
        setappdata(hfig,'u',0.8);
        setappdata(hfig,'tf',0.0075);
        setappdata(hfig,'ts',1);
        setappdata(hfig,'tus',800);
        setappdata(hfig,'tmax',5000);
        setappdata(hfig,'alpha_const',0.1);
        setappdata(hfig,'bOffset',1_;)
    end

    function y = piece_wise_bump_2(x)
        y = -1*ones(size(x,1),size(x,2));
        index1 = x<-2;
        index2 = -2<=x&x<0;
        index3 = 0<=x&x<2;
        index4 = 2<=x;
        
        y(index1) = -1;
        y(index2) = 0.5*x(index2);
        y(index3) = -0.5*x(index3);
        y(index4) = -1;
    end






end
